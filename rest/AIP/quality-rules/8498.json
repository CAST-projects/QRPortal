{
    "id": 8498,
    "name": "Avoid thread injection through API requests",
    "href": "AIP/quality-rules/8498",
    "critical": true,
    "severity": 30,
    "maxWeight": 9,
    "extension": {
        "name": "com.castsoftware.securityanalyzer",
        "href": "AIP/extensions/com.castsoftware.securityanalyzer"
    },
    "associatedValueName": "Call stack from external input source down to the target method",
    "description": "This quality rule detects potential thread injection vulnerabilities where user-controlled input from API requests is used to influence thread parameters. Using CAST data-flow engine, this metric identifies paths from external input sources down to thread-related API methods that could allow attackers to manipulate thread behavior in unintended ways.",
    "output": "List all methods that make resource calls forged by user-controllable data from API requests\n\nIt provides the following information:\n - Method full name\n - Call stack from external input source down to the target method.",
    "rationale": "The software allows externally-influenced input to directly specify thread sleep durations or timeout values. This creates an uncontrolled resource consumption vulnerability where attackers can manipulate application performance and availability.\nConsequences:\n-Denial of service (DoS): attackers can force threads to sleep for excessive periods (hours, days, or even indefinitely)\n-Resource exhaustion: in multi-threaded applications, all available threads can be made to sleep simultaneously, blocking new requests\n-Application unresponsiveness: critical application functions become unavailable to legitimate users\n-Performance degradation: even moderate sleep values can severely impact application throughput\n-Economic impact: service unavailability leads to business disruption and potential revenue loss\nThis vulnerability is particularly critical in:\n-Web applications where each request consumes a thread from a limited pool\n-Real-time systems where timing precision is essential\n-High-throughput services where performance is business-critical",
    "reference": "CWE-400: Uncontrolled Resource Consumption\nhttps://cwe.mitre.org/data/definitions/400.html\n\nCWE-383: J2EE Bad Practices: Direct Use of Threads\nhttps://cwe.mitre.org/data/definitions/383.html\n\nOpen Web Application Security Project (OWASP)  Top ten - Injection category\nhttps://www.owasp.org/index.php/Top_10-2017_A1-Injection\nhttps://owasp.org/Top10/A03_2021-Injection/\n\nCISQ: ASCSM-CWE-078",
    "remediation": "Primary recommendation: never allow externally-influenced input to directly control thread sleep durations.\nIf timing control is required:\n-Input validation with strict bounds: define maximum acceptable values (e.g., 1-5 seconds maximum)\n-Use predefined values: map user input to a limited set of acceptable durations\n-Implement timeouts: set overall operation timeouts regardless of sleep duration\n-Rate limiting: limit how frequently timing operations can be called per user/session",
    "remediationSample": "Avoid user inputs in sensitive methods.\nIf this is not possible, validate the arguments using a dedicated method and declare this method as a sanitization method for the quality rule. Example of such methods:\n\n// ----------------------------------------------------------------------------\n// 1) Java\n\nprivate static int validateAndLimitDelay(String delayInput) {\n  final int MIN_DELAY = 0;\n  final int MAX_DELAY = 5000; // 5 seconds maximum\n  final int DEFAULT_DELAY = 1000; // 1 second default\n\n  if (delayInput == null || delayInput.trim().isEmpty()) {\n  System.out.println(\"Input is empty. Using default \" + DEFAULT_DELAY + \" ms.\");\n  return DEFAULT_DELAY;\n  }\n  int requestedDelay;\n  try {\n  requestedDelay = Integer.parseInt(delayInput.trim());\n  } catch (NumberFormatException e) {\n  System.out.println(\"Invalid integer '\" + delayInput + \"'. Using default \" + DEFAULT_DELAY + \" ms.\");\n  return DEFAULT_DELAY;\n  }\n  if (requestedDelay == 0) {\n  System.out.println(\"Delay is zero. Using default \" + DEFAULT_DELAY + \" ms.\");\n  return DEFAULT_DELAY;\n  }\n  if (requestedDelay < MIN_DELAY || requestedDelay > MAX_DELAY) {\n  int clamped = Math.max(MIN_DELAY, Math.min(requestedDelay, MAX_DELAY));\n  System.out.println(\"Delay \" + requestedDelay + \" ms outside range [\" + MIN_DELAY + \",\" + MAX_DELAY + \"]. Clamping to \" + clamped + \" ms.\");\n  return clamped;\n  }\n  return requestedDelay;\n}\n\n\n// ----------------------------------------------------------------------------\n// 2) C# \n\n// Parses the input string, ensures it's an integer and clamps it between\n// the method-local Min/Max. Returns a safe int to use with Thread.Sleep.\n// Tuned for an API/worker environment.\nprivate static int ParseAndClampTimeout(string timeoutInput)\n{\n  const int MinTimeoutMs = 0;\n  const int MaxTimeoutMs = 5000;   // 5s\n  const int DefaultTimeoutMs = 1000; // 1s\n\n  if (string.IsNullOrWhiteSpace(timeoutInput))\n  {\n    Console.WriteLine($\"Input empty. Using default {DefaultTimeoutMs} ms.\");\n    return DefaultTimeoutMs;\n  }\n\n  if (!int.TryParse(timeoutInput, NumberStyles.Integer, CultureInfo.InvariantCulture, out int parsed))\n  {\n    throw new ArgumentException($\"'{timeoutInput}' is not a valid integer.\");\n  }\n\n  if (parsed < MinTimeoutMs || parsed > MaxTimeoutMs)\n  {\n    int clamped = Math.Clamp(parsed, MinTimeoutMs, MaxTimeoutMs);\n    Console.WriteLine($\"Timeout {parsed} ms outside range [{MinTimeoutMs},{MaxTimeoutMs}]. Clamping to {clamped} ms.\");\n    return clamped;\n  }\n\n  return parsed;\n}",
    "sample": "// ----------------------------------------------------------------------------\n// 1) Java\n\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class ProfileControllerUnsecure {\n  // Vulnerable: user controls thread sleep duration directly\n  @GetMapping(\"/profile/delay-unsecure\")\n  public String delay(@RequestParam(required = false) String delay) {\n    try {\n      int d = Integer.parseInt(delay);\n      Thread.sleep(d); // \u26a0\ufe0f Vulnerability: user controls sleep time\n      return \"Profile processed with delay=\" + d + \"ms\";\n    } catch (Exception e) {\n      return \"Error: \" + e.getMessage();\n    }\n  }\n}\n\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\nusing System;\nusing System.Globalization;\nusing System.Threading;\nusing System.Collections.Generic;\nusing Confluent.Kafka;\n\ninternal class Program\n{\n  // Kafka client config placeholder\n  private static readonly Dictionary<string, string> config = new()\n  {\n    { \"bootstrap.servers\", \"localhost:9092\" },\n    { \"group.id\", \"sleep-command-consumer\" },\n    { \"auto.offset.reset\", \"earliest\" }\n  };\n\n  // Vulnerable: reads a milliseconds value from Kafka and uses it directly with Thread.Sleep.\n  // Problem: a remote actor can send very large values and block a thread-pool thread -> DoS.\n  private int ProcessSleepFromKafka_unsecure()\n  {\n    using var consumer = new ConsumerBuilder<Ignore, string>(config).Build();\n    consumer.Subscribe(\"sleep-commands\");\n    var result = consumer.Consume(TimeSpan.FromSeconds(10));\n\n    if (result is null)\n      return 0;\n\n    string payload = result.Message.Value;\n\n    try\n    {\n      // Direct parse and immediate blocking sleep \u2014 vulnerable in an API/worker context.\n      int timeout = int.Parse(payload ?? \"0\", NumberStyles.Integer, CultureInfo.InvariantCulture);\n      Console.WriteLine($\"Sleeping (blocking) for {timeout} ms\");\n      Thread.Sleep(timeout); // \u26a0\ufe0f Vulnerability: blocks the consumer thread / thread-pool\n      return timeout;\n    }\n    catch (Exception ex)\n    {\n      Console.WriteLine($\"Error parsing or sleeping: {ex.Message}\");\n      return 0;\n    }\n  }\n}",
    "total": "Number of potentially vulnerable methods",
    "alternativeName": "Ensure your application does not process thread with unsanitized stream",
    "businessCriteria": [
        {
            "id": 1062100,
            "name": "CISQ-Index",
            "href": "AIP/business-criteria/1062100"
        },
        {
            "id": 1061000,
            "name": "ISO-5055-Index",
            "href": "AIP/business-criteria/1061000"
        },
        {
            "id": 66031,
            "name": "Programming Practices",
            "href": "AIP/business-criteria/66031"
        },
        {
            "id": 60016,
            "name": "Security",
            "href": "AIP/business-criteria/60016"
        }
    ],
    "technicalCriteria": [
        {
            "id": 1062189,
            "name": "ASCSM-CWE-78 - OS Command Injection Improper Input Neutralization",
            "href": "AIP/technical-criteria/1062189",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066483,
            "name": "CWE-383 - J2EE Bad Practices: Direct Use of Threads",
            "href": "AIP/technical-criteria/1066483",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061014,
            "name": "CWE-78 - Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/technical-criteria/1061014",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066178,
            "name": "CWE-78 - Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/technical-criteria/1066178",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061016,
            "name": "CWE-88 - Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')",
            "href": "AIP/technical-criteria/1061016",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066188,
            "name": "CWE-88 - Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')",
            "href": "AIP/technical-criteria/1066188",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062301,
            "name": "OWASP-2013-A1 - Injection",
            "href": "AIP/technical-criteria/1062301",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062321,
            "name": "OWASP-2017-A1 - Injection",
            "href": "AIP/technical-criteria/1062321",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062343,
            "name": "OWASP-2021-A03 - Injection",
            "href": "AIP/technical-criteria/1062343",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063155,
            "name": "PCI-DSS4-Requirement-6.2.4 - Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/technical-criteria/1063155",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063114,
            "name": "PCI-Requirement-6.5.1 - Injection flaws, particularly SQL injection",
            "href": "AIP/technical-criteria/1063114",
            "weight": 5,
            "critical": false
        },
        {
            "id": 66062,
            "name": "Secure Coding - Input Validation",
            "href": "AIP/technical-criteria/66062",
            "weight": 9,
            "critical": true
        }
    ],
    "technologies": [
        {
            "id": 138383,
            "name": "C#",
            "href": "AIP/technologies/138383"
        },
        {
            "id": 140029,
            "name": "JEE",
            "href": "AIP/technologies/140029"
        },
        {
            "id": 138385,
            "name": "VB.NET",
            "href": "AIP/technologies/138385"
        }
    ],
    "qualityStandards": [
        {
            "id": "AIP-CWE-78",
            "name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/quality-standards/AIP-STRUCTURAL-FLAW/items/AIP-CWE-78",
            "standard": "AIP-STRUCTURAL-FLAW"
        },
        {
            "id": "ASCSM-CWE-78",
            "name": "OS Command Injection Improper Input Neutralization",
            "href": "AIP/quality-standards/CISQ/items/ASCSM-CWE-78",
            "standard": "CISQ"
        },
        {
            "id": "CWE-78",
            "name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/quality-standards/CWE/items/CWE-78",
            "standard": "CWE"
        },
        {
            "id": "CWE-88",
            "name": "Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')",
            "href": "AIP/quality-standards/CWE/items/CWE-88",
            "standard": "CWE"
        },
        {
            "id": "CWE-383",
            "name": "J2EE Bad Practices: Direct Use of Threads",
            "href": "AIP/quality-standards/CWE/items/CWE-383",
            "standard": "CWE"
        },
        {
            "id": "CWE-78",
            "name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-78",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-88",
            "name": "Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-88",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-78",
            "name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-78",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "CWE-88",
            "name": "Improper Neutralization of Argument Delimiters in a Command ('Argument Injection')",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-88",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "A1-2013",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A1-2013",
            "standard": "OWASP"
        },
        {
            "id": "A1-2017",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A1-2017",
            "standard": "OWASP"
        },
        {
            "id": "A03-2021",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A03-2021",
            "standard": "OWASP"
        },
        {
            "id": "API8-2019",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/API8-2019",
            "standard": "OWASP"
        },
        {
            "id": "API10-2023",
            "name": "Unsafe Consumption of APIs",
            "href": "AIP/quality-standards/OWASP/items/API10-2023",
            "standard": "OWASP"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.1"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.2.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.2.1"
        },
        {
            "id": "PCI-DSS4-Requirement-6.2.4",
            "name": "Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/quality-standards/PCI-DSS-V4/items/PCI-DSS4-Requirement-6.2.4",
            "standard": "PCI-DSS-V4"
        },
        {
            "id": "STIG-V-222604",
            "name": "The application must protect from command injection.",
            "href": "AIP/quality-standards/STIG-V5/items/STIG-V-222604",
            "standard": "STIG-V5"
        },
        {
            "id": "STIG-V-222604",
            "name": "The application must protect from command injection.",
            "href": "AIP/quality-standards/STIG-V6/items/STIG-V-222604",
            "standard": "STIG-V6"
        }
    ],
    "parameters": [
        
    ],
    "thresholds": [
        98.0,
        99.0,
        99.5,
        99.99
    ]
}
