{
    "id": 7752,
    "name": "Avoid file path manipulation",
    "href": "AIP/quality-rules/7752",
    "critical": true,
    "severity": 20,
    "maxWeight": 9,
    "extension": {
        "name": "com.castsoftware.securityanalyzer",
        "href": "AIP/extensions/com.castsoftware.securityanalyzer"
    },
    "associatedValueName": "Call stack from user input source down to the target file path command method",
    "description": "This quality rule detects path traversal vulnerabilities by analyzing data flow from user-controlled input sources to file system operations. Using CAST's data-flow engine, it identifies execution paths where untrusted input can be used to construct file paths without proper validation, potentially allowing attackers to access files outside the intended directory structure.\nThe rule specifically searches for:\n- User input that flows directly to file operations\n- Path construction using concatenation with user-provided data\nExample of common attack vectors:\n- `../../../etc/passwd` to access system password files on Unix systems\n- `..\\..\\..\\..\\Windows\\System32\\config\\SAM` to access Windows credential stores\n- Encoding variations like `%2e%2e%2f` to bypass simple filters",
    "output": "List all methods that make resource calls forged by user input\n\nIt provides the following information:\n - Method full name\n - Call stack from user input source down to the target file path command method.",
    "rationale": "Consequences include:\n-Confidentiality breach: unauthorized access to sensitive files (configuration files, source code, system files)\n-Integrity compromise: modification or deletion of critical application or system files\n-Privilege escalation: access to files that should only be readable by privileged users\n-System compromise: in severe cases, access to system executables or configuration files that could lead to full system compromise",
    "reference": "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')\nhttps://cwe.mitre.org/data/definitions/22.html\n\nCWE-73: External Control of File Name or Path\nhttps://cwe.mitre.org/data/definitions/73.html\n\nOWASP Top 10:2021 - A04:2021 \u2013 Insecure Design\nhttps://owasp.org/Top10/A04_2021-Insecure_Design/\n\nCISQ rule: ASCSM-CWE-078.",
    "remediation": "Avoid using inputs. If it is not possible:\n- Validate input against a strict allowlist of acceptable characters (alphanumeric, specific punctuation)\n- Reject paths containing `../`, `..\\\\`, or encoded variations\n- Use path canonicalization functions to resolve relative references\n- Implement proper error handling that doesn't reveal file system structure",
    "remediationSample": "Avoid paths being concatenated with user inputs.\nIf this is not possible, validate the arguments using a dedicated method and declare this method as a sanitization method for the quality rule. Example of such methods:\n\n// ----------------------------------------------------------------------------\n// 1) Java sample\n\nprivate String getSecureFilePath(String filename) {\n  try {\n    // 1. Input validation\n    if (filename == null ||\n        !filename.matches(\"^[a-zA-Z0-9._-]+$\") ||\n        filename.contains(\"..\") ||\n        filename.length() > 255) {\n      return null;\n    }\n\n    // 2. Path canonicalization and validation\n    File baseDir = new File(\"/uploads/\").getCanonicalFile();\n    File file = new File(baseDir, filename).getCanonicalFile();\n\n    // 3. Ensure file is within allowed directory\n    if (!file.getPath().startsWith(baseDir.getPath())) {\n      return null;\n    }\n\n    return file.getPath();\n\n  } catch (IOException e) {\n    return null;\n  }\n}\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\nprivate string GetSecureFilePath(string fileName)\n{\n  // 1. Input validation\n  if (string.IsNullOrEmpty(fileName) ||\n    fileName.IndexOfAny(Path.GetInvalidFileNameChars()) != -1 ||\n    fileName.Contains(\"..\") ||\n    fileName.Length > 255)\n  {\n    return null;\n  }\n\n  // 2. Path construction with validation\n  string baseDirectory = @\"C:\\uploads\\\";\n  string fullPath = Path.Combine(baseDirectory, fileName);\n  string resolvedPath = Path.GetFullPath(fullPath);\n\n  // 3. Ensure file is within allowed directory\n  if (!resolvedPath.StartsWith(Path.GetFullPath(baseDirectory)))\n  {\n    return null;\n  }\n\n  return resolvedPath;\n}",
    "sample": "// ----------------------------------------------------------------------------\n// 1) Java sample\n\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.springframework.web.bind.annotation.*;\nimport java.io.*;\n\n@RestController\npublic class FileDownloadController_unsecure {\n  @RequestMapping(\"/download\")\n  public void downloadFile(String filename, HttpServletResponse response) throws FileNotFoundException {\n    File file = new File(\"/uploads/\" + filename); // \u26a0\ufe0f Attack if \"..\\\\..\\\\..\\\\Windows\\\\System32\\\\config\\\\SAM\"\n    FileInputStream fis = new FileInputStream(file); // Potential access to Windows credential store\n    // ... file processing\n  }\n}\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\nusing Microsoft.AspNetCore.Mvc;\nusing System.IO;\n\n[ApiController]\n[Route(\"api/[controller]\")]\npublic class FileController : Controller\n{\n  [HttpGet(\"download/{fileName}\")]\n  public ActionResult DownloadFile_unsecure(string fileName)\n  {\n    string filePath = @\"C:\\uploads\\\" + fileName; // Attack if \"..\\\\..\\\\..\\\\Windows\\\\System32\\\\config\\\\SAM\"\n    byte[] fileBytes = System.IO.File.ReadAllBytes(filePath); // \u26a0\ufe0f Potential access to Windows credential store\n    return File(fileBytes, \"application/octet-stream\", fileName);\n  }\n}",
    "total": "Number of potentially vulnerable methods",
    "alternativeName": "Ensure you do file path manipulation with trusted data",
    "businessCriteria": [
        {
            "id": 1062100,
            "name": "CISQ-Index",
            "href": "AIP/business-criteria/1062100"
        },
        {
            "id": 1061000,
            "name": "ISO-5055-Index",
            "href": "AIP/business-criteria/1061000"
        },
        {
            "id": 66031,
            "name": "Programming Practices",
            "href": "AIP/business-criteria/66031"
        },
        {
            "id": 60016,
            "name": "Security",
            "href": "AIP/business-criteria/60016"
        }
    ],
    "technicalCriteria": [
        {
            "id": 1062177,
            "name": "ASCSM-CWE-22 - Path Traversal Improper Input Neutralization",
            "href": "AIP/technical-criteria/1062177",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061010,
            "name": "CWE-22 - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "href": "AIP/technical-criteria/1061010",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066122,
            "name": "CWE-22 - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "href": "AIP/technical-criteria/1066122",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061011,
            "name": "CWE-23 - Relative Path Traversal",
            "href": "AIP/technical-criteria/1061011",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066123,
            "name": "CWE-23 - Relative Path Traversal",
            "href": "AIP/technical-criteria/1066123",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061012,
            "name": "CWE-36 - Absolute Path Traversal",
            "href": "AIP/technical-criteria/1061012",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066136,
            "name": "CWE-36 - Absolute Path Traversal",
            "href": "AIP/technical-criteria/1066136",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066173,
            "name": "CWE-73 - External Control of File Name or Path",
            "href": "AIP/technical-criteria/1066173",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062307,
            "name": "OWASP-2013-A7 - Missing Function Level Access Control",
            "href": "AIP/technical-criteria/1062307",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062325,
            "name": "OWASP-2017-A5 - Broken Access Control",
            "href": "AIP/technical-criteria/1062325",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062344,
            "name": "OWASP-2021-A04 - Insecure Design",
            "href": "AIP/technical-criteria/1062344",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063155,
            "name": "PCI-DSS4-Requirement-6.2.4 - Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/technical-criteria/1063155",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063122,
            "name": "PCI-Requirement-6.5.8 - Improper access control",
            "href": "AIP/technical-criteria/1063122",
            "weight": 5,
            "critical": false
        },
        {
            "id": 66062,
            "name": "Secure Coding - Input Validation",
            "href": "AIP/technical-criteria/66062",
            "weight": 9,
            "critical": true
        }
    ],
    "technologies": [
        {
            "id": 138383,
            "name": "C#",
            "href": "AIP/technologies/138383"
        },
        {
            "id": 140029,
            "name": "JEE",
            "href": "AIP/technologies/140029"
        },
        {
            "id": 138385,
            "name": "VB.NET",
            "href": "AIP/technologies/138385"
        }
    ],
    "qualityStandards": [
        {
            "id": "ASCSM-CWE-22",
            "name": "Path Traversal Improper Input Neutralization",
            "href": "AIP/quality-standards/CISQ/items/ASCSM-CWE-22",
            "standard": "CISQ"
        },
        {
            "id": "CWE-22",
            "name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "href": "AIP/quality-standards/CWE/items/CWE-22",
            "standard": "CWE"
        },
        {
            "id": "CWE-23",
            "name": "Relative Path Traversal",
            "href": "AIP/quality-standards/CWE/items/CWE-23",
            "standard": "CWE"
        },
        {
            "id": "CWE-36",
            "name": "Absolute Path Traversal",
            "href": "AIP/quality-standards/CWE/items/CWE-36",
            "standard": "CWE"
        },
        {
            "id": "CWE-73",
            "name": "External Control of File Name or Path",
            "href": "AIP/quality-standards/CWE/items/CWE-73",
            "standard": "CWE"
        },
        {
            "id": "CWE-22",
            "name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-22",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-23",
            "name": "Relative Path Traversal",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-23",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-36",
            "name": "Absolute Path Traversal",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-36",
            "standard": "ISO-5055"
        },
        {
            "id": "NIST-AC-3",
            "name": "Access Enforcement",
            "href": "AIP/quality-standards/NIST-SP-800-53/items/NIST-AC-3",
            "standard": "NIST-SP-800-53"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53/items/NIST-SI-10",
            "standard": "NIST-SP-800-53"
        },
        {
            "id": "NIST-AC-3",
            "name": "Access Enforcement",
            "href": "AIP/quality-standards/NIST-SP-800-53R4/items/NIST-AC-3",
            "standard": "NIST-SP-800-53R4"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53R4/items/NIST-SI-10",
            "standard": "NIST-SP-800-53R4"
        },
        {
            "id": "CWE-22",
            "name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-22",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "CWE-23",
            "name": "Relative Path Traversal",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-23",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "CWE-36",
            "name": "Absolute Path Traversal",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-36",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "A5-2017",
            "name": "Broken Access Control",
            "href": "AIP/quality-standards/OWASP/items/A5-2017",
            "standard": "OWASP"
        },
        {
            "id": "A7-2013",
            "name": "Missing Function Level Access Control",
            "href": "AIP/quality-standards/OWASP/items/A7-2013",
            "standard": "OWASP"
        },
        {
            "id": "A04-2021",
            "name": "Insecure Design",
            "href": "AIP/quality-standards/OWASP/items/A04-2021",
            "standard": "OWASP"
        },
        {
            "id": "PCI-Requirement-6.5.8",
            "name": "Improper access control",
            "href": "AIP/quality-standards/PCI-DSS-V3.1/items/PCI-Requirement-6.5.8",
            "standard": "PCI-DSS-V3.1"
        },
        {
            "id": "PCI-Requirement-6.5.8",
            "name": "Improper access control",
            "href": "AIP/quality-standards/PCI-DSS-V3.2.1/items/PCI-Requirement-6.5.8",
            "standard": "PCI-DSS-V3.2.1"
        },
        {
            "id": "PCI-DSS4-Requirement-6.2.4",
            "name": "Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/quality-standards/PCI-DSS-V4/items/PCI-DSS4-Requirement-6.2.4",
            "standard": "PCI-DSS-V4"
        }
    ],
    "parameters": [
        
    ],
    "thresholds": [
        98.0,
        99.0,
        99.5,
        99.99
    ]
}
