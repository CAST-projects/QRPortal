{
    "id": 7750,
    "name": "Avoid XPath injection",
    "href": "AIP/quality-rules/7750",
    "critical": true,
    "severity": 30,
    "maxWeight": 9,
    "extension": {
        "name": "com.castsoftware.securityanalyzer",
        "href": "AIP/extensions/com.castsoftware.securityanalyzer"
    },
    "associatedValueName": "Call stack from user input source down to the target XPath execution method",
    "description": "This quality rule identifies code that constructs XPath expressions using unsanitized user input, which can lead to XPath injection vulnerabilities. The rule detects execution paths where user-controlled data flows directly into XPath query construction without proper validation or sanitization.\nUsing CAST data-flow engine, this rule traces data flow from user input sources to XPath evaluation methods, identifying potentially vulnerable code paths.",
    "output": "List all methods that make resource calls forged by user input\n\nIt provides the following information:\n - Method full name\n - Call stack from user input source down to the target XPath execution method.",
    "rationale": "This vulnerability allows attackers to:\n-Bypass authentication: manipulate login queries to gain unauthorized access\n-Extract sensitive data: retrieve information beyond intended access levels\n-Modify query logic: alter the intended behavior of XPath expressions\n-Perform reconnaissance: gather information about XML structure and content\nThe consequences can include unauthorized data access, authentication bypass, and potential system compromise.",
    "reference": "CWE-91: XML Injection (aka Blind XPath Injection)\nhttps://cwe.mitre.org/data/definitions/91.html\n\nOpen Web Application Security Project (OWASP) - OWASP Top 10:2021\nhttps://owasp.org/Top10/fr/A03_2021-Injection/\n\nOWASP Cheat Sheet Series - XPath Injection Prevention Cheat Sheet\nhttps://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html#xpath-injection",
    "remediation": "To prevent XPath injection vulnerabilities:\n-Parameterized queries: use XPath variables or parameterized queries when possible\n-Use secure APIs: prefer XML parsing libraries that provide built-in protection against injection",
    "remediationSample": "// ----------------------------------------------------------------------------\n// 1) Java sample\n\nimport javax.xml.parsers.*;\nimport javax.xml.xpath.*;\nimport org.owasp.esapi.ESAPI;\nimport org.w3c.dom.Document;\nimport org.xml.sax.SAXException;\nimport java.io.*;\n\npublic class Main {\n\n  public static void FindUser_secure(String userId) throws XPathExpressionException, ParserConfigurationException, IOException, SAXException {\n    // Simple XML data\n    String xmlData = \"<users><user id='1' name='admin'/><user id='2' name='guest'/></users>\";\n\n    Document doc = DocumentBuilderFactory.newInstance()\n        .newDocumentBuilder()\n        .parse(new ByteArrayInputStream(xmlData.getBytes()));\n\n    String sanitizedId = ESAPI.encoder().encodeForXPath(userId);\n\n    // Secure: use of framework sanitization\n    XPath xpath = XPathFactory.newInstance().newXPath();\n    String query = \"//user[@id='\" + sanitizedId + \"']/@name\";\n    String result = xpath.evaluate(query, doc); // \u2713 OK\n\n    System.out.println(\"User: \" + (result.isEmpty() ? \"Not found\" : result));\n  }\n\n  public static void main(String[] args) throws XPathExpressionException, ParserConfigurationException, IOException, SAXException {\n    if (args.length > 0) {\n      String userId = args[0];\n      FindUser_secure(userId);\n    }\n  }\n}\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\n\nusing System;\nusing System.Xml;\nusing System.Text.Encodings.Web;\n\ninternal class Program\n{\n  static void FindUser_secure(string userId)\n  {\n    var doc = new XmlDocument();\n    doc.LoadXml(\"<users><user id='1' name='admin'/><user id='2' name='guest'/></users>\");\n\n    // Secure: using framework sanitization\n    string sanitizedId = HtmlEncoder.Default.Encode(userId);\n    string xpath = $\"//user[@id='{sanitizedId}']/@name\";\n    var result = doc.SelectSingleNode(xpath); // \u2713 OK\n    Console.WriteLine($\"User: {result?.Value ?? \"Not found\"}\");\n  }\n\n  static void Main(string[] args)\n  {\n    if (args.Length > 0)\n    {\n      string userId = args[0];\n      FindUser_secure(userId);\n    }\n  }\n}",
    "sample": "// ----------------------------------------------------------------------------\n// 1) Java sample\n\nimport javax.xml.parsers.*;\nimport javax.xml.xpath.*;\nimport org.w3c.dom.Document;\nimport org.xml.sax.SAXException;\nimport java.io.*;\n\npublic class Main {\n\n  public static void FindUser_unsecure(String userId) throws XPathExpressionException, ParserConfigurationException, IOException, SAXException {\n    // Simple XML data\n    String xmlData = \"<users><user id='1' name='admin'/><user id='2' name='guest'/></users>\";\n\n    Document doc = DocumentBuilderFactory.newInstance()\n        .newDocumentBuilder()\n        .parse(new ByteArrayInputStream(xmlData.getBytes()));\n\n    // Vulnerable: direct string concatenation\n    XPath xpath = XPathFactory.newInstance().newXPath();\n    String query = \"//user[@id='\" + userId + \"']/@name\";\n    String result = xpath.evaluate(query, doc); // \u26a0\ufe0f Vulnerability\n\n    System.out.println(\"User: \" + (result.isEmpty() ? \"Not found\" : result));\n  }\n\n  public static void main(String[] args) throws XPathExpressionException, ParserConfigurationException, IOException, SAXException {\n    if (args.length > 0) {\n      String userId = args[0];\n      FindUser_unsecure(userId);\n    }\n  }\n}\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\nusing System;\nusing System.Xml;\n\ninternal class Program\n{\n  static void FindUser_unsecure(string userId)\n  {\n    var doc = new XmlDocument();\n    doc.LoadXml(\"<users><user id='1' name='admin'/><user id='2' name='guest'/></users>\");\n\n    // Vulnerable: direct string concatenation (try with string: \"1' or '1'='1\")\n    string xpath = $\"//user[@id='{userId}']/@name\";\n    var result = doc.SelectSingleNode(xpath); // \u26a0\ufe0f Vulnerability\n    Console.WriteLine($\"User: {result?.Value ?? \"Not found\"}\");\n  }\n\n  static void Main(string[] args)\n  {\n    if (args.Length > 0)\n    {\n      string userId = args[0];\n      FindUser_unsecure(userId);\n    }\n  }\n}",
    "total": "Number of potentially vulnerable methods",
    "alternativeName": "Ensure your application properly neutralize XML content before it is processed",
    "businessCriteria": [
        {
            "id": 1061000,
            "name": "ISO-5055-Index",
            "href": "AIP/business-criteria/1061000"
        },
        {
            "id": 66031,
            "name": "Programming Practices",
            "href": "AIP/business-criteria/66031"
        },
        {
            "id": 60016,
            "name": "Security",
            "href": "AIP/business-criteria/60016"
        }
    ],
    "technicalCriteria": [
        {
            "id": 1061072,
            "name": "CWE-643 - Improper Neutralization of Data within XPath Expressions ('XPath Injection')",
            "href": "AIP/technical-criteria/1061072",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066743,
            "name": "CWE-643 - Improper Neutralization of Data within XPath Expressions ('XPath Injection')",
            "href": "AIP/technical-criteria/1066743",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1061019,
            "name": "CWE-91 - XML Injection (aka Blind XPath Injection)",
            "href": "AIP/technical-criteria/1061019",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066191,
            "name": "CWE-91 - XML Injection (aka Blind XPath Injection)",
            "href": "AIP/technical-criteria/1066191",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062301,
            "name": "OWASP-2013-A1 - Injection",
            "href": "AIP/technical-criteria/1062301",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062321,
            "name": "OWASP-2017-A1 - Injection",
            "href": "AIP/technical-criteria/1062321",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062343,
            "name": "OWASP-2021-A03 - Injection",
            "href": "AIP/technical-criteria/1062343",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063155,
            "name": "PCI-DSS4-Requirement-6.2.4 - Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/technical-criteria/1063155",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063114,
            "name": "PCI-Requirement-6.5.1 - Injection flaws, particularly SQL injection",
            "href": "AIP/technical-criteria/1063114",
            "weight": 5,
            "critical": false
        },
        {
            "id": 66062,
            "name": "Secure Coding - Input Validation",
            "href": "AIP/technical-criteria/66062",
            "weight": 9,
            "critical": true
        }
    ],
    "technologies": [
        {
            "id": 138383,
            "name": "C#",
            "href": "AIP/technologies/138383"
        },
        {
            "id": 140029,
            "name": "JEE",
            "href": "AIP/technologies/140029"
        },
        {
            "id": 138385,
            "name": "VB.NET",
            "href": "AIP/technologies/138385"
        }
    ],
    "qualityStandards": [
        {
            "id": "CWE-91",
            "name": "XML Injection (aka Blind XPath Injection)",
            "href": "AIP/quality-standards/CWE/items/CWE-91",
            "standard": "CWE"
        },
        {
            "id": "CWE-643",
            "name": "Improper Neutralization of Data within XPath Expressions ('XPath Injection')",
            "href": "AIP/quality-standards/CWE/items/CWE-643",
            "standard": "CWE"
        },
        {
            "id": "CWE-91",
            "name": "XML Injection (aka Blind XPath Injection)",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-91",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-643",
            "name": "Improper Neutralization of Data within XPath Expressions ('XPath Injection')",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-643",
            "standard": "ISO-5055"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53/items/NIST-SI-10",
            "standard": "NIST-SP-800-53"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53R4/items/NIST-SI-10",
            "standard": "NIST-SP-800-53R4"
        },
        {
            "id": "CWE-91",
            "name": "XML Injection (aka Blind XPath Injection)",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-91",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "CWE-643",
            "name": "Improper Neutralization of Data within XPath Expressions ('XPath Injection')",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-643",
            "standard": "OMG-ASCQM"
        },
        {
            "id": "A1-2013",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A1-2013",
            "standard": "OWASP"
        },
        {
            "id": "A1-2017",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A1-2017",
            "standard": "OWASP"
        },
        {
            "id": "A03-2021",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/A03-2021",
            "standard": "OWASP"
        },
        {
            "id": "API8-2019",
            "name": "Injection",
            "href": "AIP/quality-standards/OWASP/items/API8-2019",
            "standard": "OWASP"
        },
        {
            "id": "API10-2023",
            "name": "Unsafe Consumption of APIs",
            "href": "AIP/quality-standards/OWASP/items/API10-2023",
            "standard": "OWASP"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.1"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.2.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.2.1"
        },
        {
            "id": "PCI-DSS4-Requirement-6.2.4",
            "name": "Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/quality-standards/PCI-DSS-V4/items/PCI-DSS4-Requirement-6.2.4",
            "standard": "PCI-DSS-V4"
        },
        {
            "id": "STIG-V-222604",
            "name": "The application must protect from command injection.",
            "href": "AIP/quality-standards/STIG-V5/items/STIG-V-222604",
            "standard": "STIG-V5"
        },
        {
            "id": "STIG-V-222604",
            "name": "The application must protect from command injection.",
            "href": "AIP/quality-standards/STIG-V6/items/STIG-V-222604",
            "standard": "STIG-V6"
        }
    ],
    "parameters": [
        
    ],
    "thresholds": [
        98.0,
        99.0,
        99.5,
        99.99
    ]
}
