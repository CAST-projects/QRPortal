{
    "id": 1019406,
    "name": "Avoid using DbSet queries ToList()/ToArray()/ToDictionary() in foreach clause",
    "href": "AIP/quality-rules/1019406",
    "critical": true,
    "severity": 20,
    "maxWeight": 7,
    "extension": {
        "name": "com.castsoftware.entity",
        "href": "AIP/extensions/com.castsoftware.entity"
    },
    "associatedValueName": "Number of violation occurrences",
    "description": "The DbSet class is derived from IQuerayable. So, we can use LINQ for querying against DbSet, which will be converted to an SQL query. EF API executes this SQL query to the underlying database, gets the flat result set, converts it into appropriate entity objects and returns it as a query result.",
    "output": "Associated to each violation, the following information is provided:\n- The number of violation occurrences\n- Bookmarks for violation occurrences found in the source code",
    "rationale": "The DbSet class is derived from IQuerayable. So, we can use LINQ for querying against DbSet, which will be converted to an SQL query. EF API executes this SQL query to the underlying database, gets the flat result set, converts it into appropriate entity objects and returns it as a query result.\n\nCalling ToList()/ToArray() on IEnumerable creates a new list/array and populates it with all items of the data set, thereby executing the LINQ query associated to the IEnumerable object and performing a \u201cfull scan\u201d. IEnumerable has been built to work seamlessly with \u201cforeach\u201d loops and calling ToList()/ToArray() should be avoided to save memory and CPU.",
    "reference": "https://learn.microsoft.com/en-us/ef/core/querying/client-eval#avoiding-premature-query-execution\nhttps://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asasyncenumerable\nhttps://learn.microsoft.com/en-us/ef/core/performance/",
    "remediation": "Do not materialize the full result set in memory unless absolutely required.\nInstead, prefer lazy iteration (foreach over IQueryable<T>) or use asynchronous streaming via .AsAsyncEnumerable() when dealing with Entity Framework Core.\n\nRemediation Steps:\n- Remove .ToList(), .ToArray(), or .ToDictionary() if you don\u2019t need to manipulate the entire dataset in memory.\n- Use await foreach with .AsAsyncEnumerable() in async contexts for better scalability.\n- If filtering or sorting is needed, apply it at the query level using LINQ before the iteration.",
    "remediationSample": "# Preferred\n\nawait foreach (var item in dbContext.Users.AsAsyncEnumerable())\n{\n    Console.WriteLine(item.Name); // \u2713 FIXED\n}\n\n# Preferred synchronous context is acceptable and dataset is small\n\nforeach (var item in dbContext.Users)\n{\n    Console.WriteLine(item.Name); // \u2713 FIXED\n}\n\n# if you really need the converted data\n\nvar studentsList = context.Students.ToList ();\n\nforeach(var student in studentsList) // \u2713 FIXED\n{\n  ...\n}",
    "sample": "using (var context = new ApplicationDbContext ())\n{\n    foreach(var student in context.Students.ToList()) // \u26a0\ufe0f VIOLATION\n    {\n      ...\n    }\n \n    foreach(var student in context.Students.ToArray()) // \u26a0\ufe0f VIOLATION\n    {\n      ...\n    }\n \n    foreach(var student in context.Students.ToDictionary (x => x.Id)) // \u26a0\ufe0f VIOLATION\n    {\n      ...\n    }\n}",
    "alternativeName": "Ensure you don't convert DbSet in foreach clause",
    "businessCriteria": [
        {
            "id": 60014,
            "name": "Efficiency",
            "href": "AIP/business-criteria/60014"
        },
        {
            "id": 20140522,
            "name": "Green",
            "href": "AIP/business-criteria/20140522"
        },
        {
            "id": 66031,
            "name": "Programming Practices",
            "href": "AIP/business-criteria/66031"
        }
    ],
    "technicalCriteria": [
        {
            "id": 61019,
            "name": "Efficiency - SQL and Data Handling Performance",
            "href": "AIP/technical-criteria/61019",
            "weight": 7,
            "critical": true
        }
    ],
    "technologies": [
        {
            "id": 138383,
            "name": "C#",
            "href": "AIP/technologies/138383"
        }
    ],
    "qualityStandards": [
        {
            "id": "AIP-CWE-1050",
            "name": "Excessive Platform Resource Consumption within a Loop",
            "href": "AIP/quality-standards/AIP-STRUCTURAL-FLAW/items/AIP-CWE-1050",
            "standard": "AIP-STRUCTURAL-FLAW"
        },
        {
            "id": "ASCPEM-PRF-8",
            "name": "Control Elements Requiring Significant Resource Element within Control Flow Loop Block",
            "href": "AIP/quality-standards/CISQ/items/ASCPEM-PRF-8",
            "standard": "CISQ"
        },
        {
            "id": "CWE-1050",
            "name": "Excessive Platform Resource Consumption within a Loop",
            "href": "AIP/quality-standards/CWE/items/CWE-1050",
            "standard": "CWE"
        },
        {
            "id": "CWE-1050",
            "name": "Excessive Platform Resource Consumption within a Loop",
            "href": "AIP/quality-standards/ISO-5055/items/CWE-1050",
            "standard": "ISO-5055"
        },
        {
            "id": "CWE-1050",
            "name": "Excessive Platform Resource Consumption within a Loop",
            "href": "AIP/quality-standards/OMG-ASCQM/items/CWE-1050",
            "standard": "OMG-ASCQM"
        }
    ],
    "parameters": [
        
    ],
    "thresholds": [
        0.0,
        0.0,
        0.0,
        0.0
    ]
}
