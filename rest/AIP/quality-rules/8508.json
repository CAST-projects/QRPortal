{
    "id": 8508,
    "name": "Avoid log forging through API requests",
    "href": "AIP/quality-rules/8508",
    "critical": true,
    "severity": 20,
    "maxWeight": 8,
    "extension": {
        "name": "com.castsoftware.securityanalyzer",
        "href": "AIP/extensions/com.castsoftware.securityanalyzer"
    },
    "associatedValueName": "Call stack from external input source down to the target method",
    "description": "This quality rule uses CAST's data-flow engine to detect call paths where input data originating from API requests is written to application logs without prior validation and sanitization.\nThe rule identifies scenarios where untrusted data from API sources flows directly into logging statements, creating potential log injection vulnerabilities that attackers could exploit to manipulate log entries.",
    "output": "List all methods that make log method calls forged by user-controllable data from API requests\n\nIt provides the following information:\n - Method full name\n - Call stack from external input source down to the target method.",
    "rationale": "When applications log data received from API requests without sanitization, attackers can inject malicious content that corrupts log files, misleads administrators, or even exploits log processing systems.\n-Log corruption: attackers can inject newline characters (\\n, \\r) to create fake log entries or split existing entries\n-Administrative confusion: forged entries can hide malicious activity or create false alerts\n-Log processing attacks: if logs are processed by automated tools, injected content could exploit parsing vulnerabilities\n-Security monitoring bypass: attackers can obscure their tracks by manipulating log content",
    "reference": "CWE-117: Improper Output Neutralization for Logs\nhttps://cwe.mitre.org/data/definitions/117.html\n\nOWASP Top Ten 2021 Category A09:2021 - Security Logging and Monitoring Failures\nhttps://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/\n\nOWASP Cheat Sheet Series - Logging Cheat Sheet\nhttps://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html",
    "remediation": "To prevent log forging from API requests:\n-Sanitize all API input before logging by removing or escaping dangerous characters\n-Use parameterized logging where available (e.g., SLF4J with placeholders)\n-Validate input format and reject malformed data\n-Encode special characters that could be interpreted as control sequences",
    "remediationSample": "// ----------------------------------------------------------------------------\n// 1) Java\n\nimport org.apache.commons.lang3.StringEscapeUtils;\nimport org.apache.logging.log4j.*;\nimport org.springframework.web.bind.annotation.*;\n\n@RestController\npublic class ApiController_secure {\n  private static final Logger logger = LogManager.getLogger(ApiController_secure.class);\n\n  @PostMapping(\"/api/process\")\n  public String processData(@RequestParam String userId, @RequestParam String action) {\n\n    // Sanitize API input before logging\n    String sanitizedUserId = sanitizeForLog(userId);\n    String sanitizedAction = sanitizeForLog(action);\n\n    // \u2713 OK: use parameterized logging with sanitized values\n    logger.info(\"API request from user: {}, action: {}\", sanitizedUserId, sanitizedAction);\n\n    return \"Processed\";\n  }\n\n  private String sanitizeForLog(String input) {\n    if (input == null) return \"[null]\";\n\n    // Remove control characters (newlines, carriage returns, tabs)\n    String sanitized = input.replaceAll(\"[\\r\\n\\t]\", \"_\");\n\n    // HTML encode to neutralize special characters\n    sanitized = StringEscapeUtils.escapeHtml4(sanitized);\n\n    // Limit length to prevent log flooding\n    return sanitized.length() > 100 ? sanitized.substring(0, 100) + \"...\" : sanitized;\n  }\n}\n\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\nusing Confluent.Kafka;\nusing log4net;\nusing System.Text.RegularExpressions;\nusing System.Web;\n\npublic class EventProcessor_secure\n{\n  private static readonly ILog _logger = LogManager.GetLogger(typeof(EventProcessor_secure));\n\n  public void ProcessEvent(ConsumerConfig config)\n  {\n    using var consumer = new ConsumerBuilder<Ignore, string>(config).Build();\n    consumer.Subscribe(\"events-topic\");\n\n    var result = consumer.Consume(TimeSpan.FromSeconds(10));\n    if (result != null)\n    {\n      string eventData = result.Message.Value;\n      string eventType = System.Text.Encoding.UTF8.GetString(\n        result.Message.Headers.GetLastBytes(\"event-type\"));\n\n      // Sanitize Kafka message data before logging\n      string sanitizedType = SanitizeLogInput(eventType);\n      string sanitizedData = SanitizeLogInput(eventData);\n\n      // \u2713 OK: use string formatting with sanitized values\n      _logger.InfoFormat(\"Received event: {0}, data: {1}\", sanitizedType, sanitizedData);\n    }\n  }\n\n  private string SanitizeLogInput(string input)\n  {\n    if (string.IsNullOrWhiteSpace(input)) return \"[empty]\";\n\n    // Remove control characters including CRLF\n    string sanitized = Regex.Replace(input, @\"[\\r\\n\\t\\p{C}]\", \"_\");\n\n    // HTML encode to neutralize special characters\n    sanitized = HttpUtility.HtmlEncode(sanitized);\n\n    // Limit length to prevent log flooding\n    return sanitized.Length > 80 ? sanitized.Substring(0, 80) + \"...\" : sanitized;\n  }\n}",
    "sample": "// ----------------------------------------------------------------------------\n// 1) Java\n\nimport org.apache.logging.log4j.*;\nimport org.springframework.web.bind.annotation.*;\n\n@RestController\npublic class ApiController_unsecure {\n  private static final Logger logger = LogManager.getLogger(ApiController_unsecure.class);\n\n  @PostMapping(\"/api/process\")\n  public String processData(@RequestParam String userId, @RequestParam String action) {\n\n    // \u26a0\ufe0f Vulnerability: attacker could inject: \"user123\\n[INFO] Admin granted full access\"\n    logger.info(\"API request from user: \" + userId + \", action: \" + action);\n\n    return \"Processed\";\n  }\n}\n\n\n// ----------------------------------------------------------------------------\n// 2) C# sample\n\nusing Confluent.Kafka;\nusing log4net;\nusing System.Web;\n\npublic class EventProcessor_unsecure\n{\n  private static readonly ILog _logger = LogManager.GetLogger(typeof(EventProcessor_unsecure));\n\n  public void ProcessEvent(ConsumerConfig config)\n  {\n    using var consumer = new ConsumerBuilder<Ignore, string>(config).Build();\n    consumer.Subscribe(\"events-topic\");\n\n    var result = consumer.Consume(TimeSpan.FromSeconds(10));\n    if (result != null)\n    {\n      string eventData = result.Message.Value;\n      string eventType = System.Text.Encoding.UTF8.GetString(\n        result.Message.Headers.GetLastBytes(\"event-type\"));\n\n      // \u26a0\ufe0f Vulnerability: attacker could inject via Kafka: \"payment\\r\\n[ERROR] Security breach detected\"\n      _logger.Info($\"Received event: {eventType}, data: {eventData}\");\n    }\n  }\n}",
    "total": "Number of potentially vulnerable methods",
    "alternativeName": "Ensure when you build a log that accepts a format string as an argument, the argument has been sanitized when it originates from an external source.",
    "businessCriteria": [
        {
            "id": 66031,
            "name": "Programming Practices",
            "href": "AIP/business-criteria/66031"
        },
        {
            "id": 60016,
            "name": "Security",
            "href": "AIP/business-criteria/60016"
        }
    ],
    "technicalCriteria": [
        {
            "id": 1066217,
            "name": "CWE-117 - Improper Output Neutralization for Logs",
            "href": "AIP/technical-criteria/1066217",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1066193,
            "name": "CWE-93 - Improper Neutralization of CRLF Sequences ('CRLF Injection')",
            "href": "AIP/technical-criteria/1066193",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062306,
            "name": "OWASP-2013-A6 - Sensitive Data Exposure",
            "href": "AIP/technical-criteria/1062306",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062323,
            "name": "OWASP-2017-A3 - Sensitive Data Exposure",
            "href": "AIP/technical-criteria/1062323",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1062349,
            "name": "OWASP-2021-A09 - Security Logging and Monitoring Failures",
            "href": "AIP/technical-criteria/1062349",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063155,
            "name": "PCI-DSS4-Requirement-6.2.4 - Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/technical-criteria/1063155",
            "weight": 5,
            "critical": false
        },
        {
            "id": 1063114,
            "name": "PCI-Requirement-6.5.1 - Injection flaws, particularly SQL injection",
            "href": "AIP/technical-criteria/1063114",
            "weight": 5,
            "critical": false
        },
        {
            "id": 66062,
            "name": "Secure Coding - Input Validation",
            "href": "AIP/technical-criteria/66062",
            "weight": 8,
            "critical": true
        }
    ],
    "technologies": [
        {
            "id": 138383,
            "name": "C#",
            "href": "AIP/technologies/138383"
        },
        {
            "id": 140029,
            "name": "JEE",
            "href": "AIP/technologies/140029"
        },
        {
            "id": 138385,
            "name": "VB.NET",
            "href": "AIP/technologies/138385"
        }
    ],
    "qualityStandards": [
        {
            "id": "CWE-93",
            "name": "Improper Neutralization of CRLF Sequences ('CRLF Injection')",
            "href": "AIP/quality-standards/CWE/items/CWE-93",
            "standard": "CWE"
        },
        {
            "id": "CWE-117",
            "name": "Improper Output Neutralization for Logs",
            "href": "AIP/quality-standards/CWE/items/CWE-117",
            "standard": "CWE"
        },
        {
            "id": "NIST-AU-9",
            "name": "Protection of Audit Information",
            "href": "AIP/quality-standards/NIST-SP-800-53/items/NIST-AU-9",
            "standard": "NIST-SP-800-53"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53/items/NIST-SI-10",
            "standard": "NIST-SP-800-53"
        },
        {
            "id": "NIST-AU-9",
            "name": "Protection of Audit Information",
            "href": "AIP/quality-standards/NIST-SP-800-53R4/items/NIST-AU-9",
            "standard": "NIST-SP-800-53R4"
        },
        {
            "id": "NIST-SI-10",
            "name": "Information Input Validation",
            "href": "AIP/quality-standards/NIST-SP-800-53R4/items/NIST-SI-10",
            "standard": "NIST-SP-800-53R4"
        },
        {
            "id": "A3-2017",
            "name": "Sensitive Data Exposure",
            "href": "AIP/quality-standards/OWASP/items/A3-2017",
            "standard": "OWASP"
        },
        {
            "id": "A6-2013",
            "name": "Sensitive Data Exposure",
            "href": "AIP/quality-standards/OWASP/items/A6-2013",
            "standard": "OWASP"
        },
        {
            "id": "A09-2021",
            "name": "Security Logging and Monitoring Failures",
            "href": "AIP/quality-standards/OWASP/items/A09-2021",
            "standard": "OWASP"
        },
        {
            "id": "API10-2019",
            "name": "Insufficient Logging & Monitoring",
            "href": "AIP/quality-standards/OWASP/items/API10-2019",
            "standard": "OWASP"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.1"
        },
        {
            "id": "PCI-Requirement-6.5.1",
            "name": "Injection flaws, particularly SQL injection",
            "href": "AIP/quality-standards/PCI-DSS-V3.2.1/items/PCI-Requirement-6.5.1",
            "standard": "PCI-DSS-V3.2.1"
        },
        {
            "id": "PCI-DSS4-Requirement-6.2.4",
            "name": "Software engineering techniques or other methods are defined and in use by software development personnel to prevent or mitigate common software attacks and related vulnerabilities",
            "href": "AIP/quality-standards/PCI-DSS-V4/items/PCI-DSS4-Requirement-6.2.4",
            "standard": "PCI-DSS-V4"
        },
        {
            "id": "STIG-V-222444",
            "name": "The application must not write sensitive data into the application logs.",
            "href": "AIP/quality-standards/STIG-V5/items/STIG-V-222444",
            "standard": "STIG-V5"
        },
        {
            "id": "STIG-V-222444",
            "name": "The application must not write sensitive data into the application logs.",
            "href": "AIP/quality-standards/STIG-V6/items/STIG-V-222444",
            "standard": "STIG-V6"
        }
    ],
    "parameters": [
        
    ],
    "thresholds": [
        98.0,
        99.0,
        99.5,
        99.99
    ]
}
